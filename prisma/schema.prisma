// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["app"]
}

// ===== ENUMS =====

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CONTENT_CREATOR
  VIEWER

  @@schema("app")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION

  @@schema("app")
}

enum TourStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  UNDER_REVIEW

  @@schema("app")
}

enum TourDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED

  @@schema("app")
}

enum HotspotType {
  NAVIGATION
  INFO
  INTERACTIVE

  @@schema("app")
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT

  @@schema("app")
}

enum MediaStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
  ARCHIVED

  @@schema("app")
}

enum AnalyticsEventType {
  TOUR_VIEW
  SCENE_VIEW
  HOTSPOT_CLICK
  TOUR_SHARE
  TOUR_BOOKMARK
  SESSION_START
  SESSION_END

  @@schema("app")
}

// ===== CORE ENTITIES =====

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  username  String?    @unique
  firstName String?    @map("first_name")
  lastName  String?    @map("last_name")
  avatar    String?
  role      UserRole   @default(VIEWER)
  status    UserStatus @default(PENDING_VERIFICATION)
  language  String     @default("en")
  timezone  String     @default("UTC")

  // Authentication
  hashedPassword         String?   @map("hashed_password")
  emailVerifiedAt        DateTime? @map("email_verified_at")
  lastLoginAt            DateTime? @map("last_login_at")
  passwordResetToken     String?   @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")

  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relationships
  createdTours       VirtualTour[]    @relation("TourCreator")
  updatedTours       VirtualTour[]    @relation("TourUpdater")
  userSessions       UserSession[]
  analyticsEvents    AnalyticsEvent[]
  tourBookmarks      TourBookmark[]
  tourRatings        TourRating[]
  apiKeys            ApiKey[]
  uploadedMediaFiles MediaFile[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@map("users")
  @@schema("app")
}

model VirtualTour {
  id           String          @id @default(cuid())
  title        String
  description  String?
  location     String?
  slug         String          @unique
  status       TourStatus      @default(DRAFT)
  difficulty   TourDifficulty? @default(BEGINNER)
  category     String?
  tags         String[]
  thumbnailUrl String?         @map("thumbnail_url")

  // SEO and metadata
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")
  metaKeywords    String[] @map("meta_keywords")

  // Tour settings
  allowPublicAccess Boolean @default(true) @map("allow_public_access")
  allowEmbedding    Boolean @default(true) @map("allow_embedding")
  autoplayEnabled   Boolean @default(false) @map("autoplay_enabled")
  autoplaySpeed     Int?    @default(2) @map("autoplay_speed") // seconds per rotation

  // Statistics
  viewCount     Int    @default(0) @map("view_count")
  shareCount    Int    @default(0) @map("share_count")
  bookmarkCount Int    @default(0) @map("bookmark_count")
  averageRating Float? @default(0) @map("average_rating")
  totalRatings  Int    @default(0) @map("total_ratings")

  // Computed metadata
  totalScenes       Int  @default(0) @map("total_scenes")
  totalHotspots     Int  @default(0) @map("total_hotspots")
  estimatedDuration Int? @map("estimated_duration") // in minutes

  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")
  deletedAt   DateTime? @map("deleted_at")

  // Foreign keys
  createdById String? @map("created_by_id")
  updatedById String? @map("updated_by_id")

  // Relationships
  createdBy       User?             @relation("TourCreator", fields: [createdById], references: [id])
  updatedBy       User?             @relation("TourUpdater", fields: [updatedById], references: [id])
  scenes          Scene[]
  translations    TourTranslation[]
  bookmarks       TourBookmark[]
  ratings         TourRating[]
  analyticsEvents AnalyticsEvent[]
  embeds          TourEmbed[]

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([createdById])
  @@index([createdAt])
  @@index([publishedAt])
  @@index([tags])
  @@map("virtual_tours")
  @@schema("app")
}

model Scene {
  id           String  @id @default(cuid())
  title        String
  description  String?
  order        Int
  panoramaUrl  String  @map("panorama_url")
  thumbnailUrl String? @map("thumbnail_url")

  // Scene positioning (for map integration)
  mapPositionX Float? @map("map_position_x")
  mapPositionY Float? @map("map_position_y")

  // Scene settings
  initialViewAngle Float? @default(0) @map("initial_view_angle") // degrees
  maxZoom          Float? @default(3) @map("max_zoom")
  minZoom          Float? @default(0.5) @map("min_zoom")

  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Foreign keys
  tourId String @map("tour_id")

  // Relationships
  tour            VirtualTour        @relation(fields: [tourId], references: [id], onDelete: Cascade)
  hotspots        Hotspot[]
  hotspotTargets  Hotspot[]          @relation("HotspotTarget")
  translations    SceneTranslation[]
  mediaFiles      SceneMedia[]
  analyticsEvents AnalyticsEvent[]

  @@unique([tourId, order])
  @@index([tourId])
  @@index([order])
  @@map("scenes")
  @@schema("app")
}

model Hotspot {
  id          String      @id @default(cuid())
  type        HotspotType
  title       String
  description String?

  // 3D positioning
  positionX Float @map("position_x")
  positionY Float @map("position_y")
  positionZ Float @map("position_z")

  // Visual settings
  iconUrl   String? @map("icon_url")
  iconColor String? @default("#ffffff") @map("icon_color")
  iconSize  Float?  @default(1.0) @map("icon_size")

  // Content for info hotspots
  content Json? // Flexible content structure

  // Navigation settings
  targetSceneId String? @map("target_scene_id")

  // Animation settings
  animationType  String? @default("pulse") @map("animation_type")
  animationSpeed Float?  @default(1.0) @map("animation_speed")

  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Foreign keys
  sceneId String @map("scene_id")

  // Relationships
  scene           Scene                @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  targetScene     Scene?               @relation("HotspotTarget", fields: [targetSceneId], references: [id])
  translations    HotspotTranslation[]
  mediaFiles      HotspotMedia[]
  analyticsEvents AnalyticsEvent[]

  @@index([sceneId])
  @@index([type])
  @@index([targetSceneId])
  @@map("hotspots")
  @@schema("app")
}

// ===== MEDIA MANAGEMENT =====

model MediaFile {
  id           String      @id @default(cuid())
  originalName String      @map("original_name")
  fileName     String      @unique @map("file_name")
  filePath     String      @map("file_path")
  file_size    Int         @map("file_size")
  mimeType     String      @map("mime_type")
  mediaType    MediaType   @map("media_type")
  status       MediaStatus @default(UPLOADING)

  // Image/Video specific
  width    Int?
  height   Int?
  duration Float? // for videos/audio in seconds

  // Processing metadata
  processingLog  String? @map("processing_log")
  thumbnailPath  String? @map("thumbnail_path")
  compressedPath String? @map("compressed_path")

  // Storage metadata
  storageProvider String? @default("local") @map("storage_provider")
  externalUrl     String? @map("external_url")

  // Audit fields
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Foreign keys
  uploadedById String? @map("uploaded_by_id")

  // Relationships
  uploadedBy   User?          @relation(fields: [uploadedById], references: [id])
  sceneMedia   SceneMedia[]
  hotspotMedia HotspotMedia[]

  @@index([fileName])
  @@index([mediaType])
  @@index([status])
  @@index([uploadedById])
  @@map("media_files")
  @@schema("app")
}

model SceneMedia {
  id          String @id @default(cuid())
  sceneId     String @map("scene_id")
  mediaFileId String @map("media_file_id")
  mediaType   String @map("media_type") // 'panorama', 'thumbnail', 'background_audio'
  order       Int?   @default(0)

  scene     Scene     @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  mediaFile MediaFile @relation(fields: [mediaFileId], references: [id], onDelete: Cascade)

  @@unique([sceneId, mediaFileId])
  @@index([sceneId])
  @@index([mediaFileId])
  @@map("scene_media")
  @@schema("app")
}

model HotspotMedia {
  id          String @id @default(cuid())
  hotspotId   String @map("hotspot_id")
  mediaFileId String @map("media_file_id")
  mediaType   String @map("media_type") // 'icon', 'content_image', 'content_video'
  order       Int?   @default(0)

  hotspot   Hotspot   @relation(fields: [hotspotId], references: [id], onDelete: Cascade)
  mediaFile MediaFile @relation(fields: [mediaFileId], references: [id], onDelete: Cascade)

  @@unique([hotspotId, mediaFileId])
  @@index([hotspotId])
  @@index([mediaFileId])
  @@map("hotspot_media")
  @@schema("app")
}

// ===== INTERNATIONALIZATION =====

model TourTranslation {
  id              String  @id @default(cuid())
  tourId          String  @map("tour_id")
  language        String
  title           String
  description     String?
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description")

  tour VirtualTour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([tourId, language])
  @@index([tourId])
  @@index([language])
  @@map("tour_translations")
  @@schema("app")
}

model SceneTranslation {
  id          String  @id @default(cuid())
  sceneId     String  @map("scene_id")
  language    String
  title       String
  description String?

  scene Scene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@unique([sceneId, language])
  @@index([sceneId])
  @@index([language])
  @@map("scene_translations")
  @@schema("app")
}

model HotspotTranslation {
  id          String  @id @default(cuid())
  hotspotId   String  @map("hotspot_id")
  language    String
  title       String
  description String?
  content     Json?

  hotspot Hotspot @relation(fields: [hotspotId], references: [id], onDelete: Cascade)

  @@unique([hotspotId, language])
  @@index([hotspotId])
  @@index([language])
  @@map("hotspot_translations")
  @@schema("app")
}

// ===== ANALYTICS & TRACKING =====

model UserSession {
  id           String  @id @default(cuid())
  sessionToken String  @unique @map("session_token")
  userId       String? @map("user_id")
  ipAddress    String? @map("ip_address")
  userAgent    String? @map("user_agent")
  deviceType   String? @map("device_type") // 'desktop', 'mobile', 'tablet'
  browser      String?
  os           String?
  country      String?
  city         String?

  startedAt      DateTime  @default(now()) @map("started_at")
  endedAt        DateTime? @map("ended_at")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")

  user            User?            @relation(fields: [userId], references: [id])
  analyticsEvents AnalyticsEvent[]

  @@index([sessionToken])
  @@index([userId])
  @@index([startedAt])
  @@map("user_sessions")
  @@schema("app")
}

model AnalyticsEvent {
  id        String             @id @default(cuid())
  eventType AnalyticsEventType @map("event_type")
  sessionId String?            @map("session_id")
  userId    String?            @map("user_id")
  tourId    String?            @map("tour_id")
  sceneId   String?            @map("scene_id")
  hotspotId String?            @map("hotspot_id")

  // Event metadata
  eventData Json?    @map("event_data")
  duration  Float? // in seconds
  timestamp DateTime @default(now())

  // Geographic data
  ipAddress String? @map("ip_address")
  country   String?
  city      String?

  session UserSession? @relation(fields: [sessionId], references: [id])
  user    User?        @relation(fields: [userId], references: [id])
  tour    VirtualTour? @relation(fields: [tourId], references: [id])
  scene   Scene?       @relation(fields: [sceneId], references: [id])
  hotspot Hotspot?     @relation(fields: [hotspotId], references: [id])

  @@index([eventType])
  @@index([timestamp])
  @@index([sessionId])
  @@index([userId])
  @@index([tourId])
  @@index([sceneId])
  @@index([hotspotId])
  @@map("analytics_events")
  @@schema("app")
}

// ===== USER ENGAGEMENT =====

model TourBookmark {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tourId    String   @map("tour_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour VirtualTour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([userId, tourId])
  @@index([userId])
  @@index([tourId])
  @@map("tour_bookmarks")
  @@schema("app")
}

model TourRating {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tourId    String   @map("tour_id")
  rating    Int // 1-5 stars
  review    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour VirtualTour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([userId, tourId])
  @@index([userId])
  @@index([tourId])
  @@index([rating])
  @@map("tour_ratings")
  @@schema("app")
}

// ===== API & EMBEDDING =====

model ApiKey {
  id      String @id @default(cuid())
  name    String
  keyHash String @unique @map("key_hash")
  userId  String @map("user_id")

  // Permissions
  allowRead      Boolean @default(true) @map("allow_read")
  allowWrite     Boolean @default(false) @map("allow_write")
  allowAnalytics Boolean @default(false) @map("allow_analytics")

  // Limits
  requestsPerDay Int?     @default(1000) @map("requests_per_day")
  requestsCount  Int      @default(0) @map("requests_count")
  lastResetAt    DateTime @default(now()) @map("last_reset_at")

  // Status
  isActive   Boolean   @default(true) @map("is_active")
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
  @@index([isActive])
  @@map("api_keys")
  @@schema("app")
}

model TourEmbed {
  id         String  @id @default(cuid())
  tourId     String  @map("tour_id")
  embedToken String  @unique @map("embed_token")
  domain     String? // Allowed domain for embedding

  // Embed settings
  width        String? @default("100%")
  height       String? @default("500px")
  showControls Boolean @default(true) @map("show_controls")
  showBranding Boolean @default(true) @map("show_branding")
  autoplay     Boolean @default(false)

  // Statistics
  embedViews   Int       @default(0) @map("embed_views")
  lastAccessAt DateTime? @map("last_access_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tour VirtualTour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@index([embedToken])
  @@index([tourId])
  @@index([domain])
  @@map("tour_embeds")
  @@schema("app")
}
